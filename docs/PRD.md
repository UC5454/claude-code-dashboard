# PRD: Claude Code Usage Dashboard

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Claude Code Usage Dashboard |
| バージョン | 1.0 |
| 作成日 | 2026-02-07 |
| 作成者 | 神崎凛（COO） |
| ステータス | Draft |

---

## 1. エグゼクティブサマリー

Claude Code Usage Dashboardは、チーム全体のClaude Code利用状況をリアルタイムに可視化するWebアプリケーションである。

Claude Codeのhooksプラグインシステムを活用し、Skill実行・Subagent起動・MCP呼び出し・メッセージ送信などのイベントデータを自動収集。集計されたデータをダッシュボード上でKPIカード・時系列グラフ・ランキングテーブルとして表示し、さらにGemini APIによるAI Insightsで利用パターンの分析を提供する。

主要ユーザーはチーム管理者・マネージャー（千葉勇志が主要ユーザー）であり、Claude Codeの活用促進・利用パターン把握・チーム生産性の向上を実現する。

---

## 2. 背景・課題

### 背景

- Claude Codeはチーム開発における中核ツールとして導入が進んでいる
- 現状、各メンバーの利用状況は個人に閉じており、チーム全体としての活用度合いが見えない
- Claude Codeにはhooksプラグインシステムがあり、各種イベントをフックしてデータを外部に送出する仕組みが存在する

### 課題

| # | 課題 | 影響 |
|---|------|------|
| 1 | 誰がどの程度Claude Codeを活用しているか不明 | 活用促進の施策が打てない |
| 2 | どの機能（Skill/MCP/Subagent等）が使われているか不明 | 投資対効果の判断ができない |
| 3 | 利用トレンドの変化を察知できない | 問題の早期発見・対応が遅れる |
| 4 | ベストプラクティスの共有が属人的 | ナレッジの横展開が進まない |

---

## 3. 目的・ゴール

### 目的

チームのClaude Code利用状況を定量的に可視化し、活用促進・利用パターン把握・意思決定支援を実現する。

### ゴール

| ゴール | 指標 | 目標値 |
|--------|------|--------|
| 利用状況の可視化 | ダッシュボードで確認可能なKPI数 | 6種以上 |
| 活用促進 | チーム全体のアクティブ率 | 90%以上維持 |
| パターン把握 | AI Insightsによる自動分析 | 週次で5件以上の示唆 |
| 迅速な状況把握 | ダッシュボード初回表示速度 | 3秒以内 |

### KPI

- **アクティブユーザー率**: アクティブユーザー数 / 全ユーザー数
- **総セッション数**: 期間内のClaude Codeセッション数
- **機能別利用数**: Skill / Subagent / MCP / Command / Message 各カテゴリの実行数
- **前期比成長率**: 各KPIの前期間比較（%）

---

## 4. ユーザー特性

### プライマリユーザー: チーム管理者・マネージャー

| 属性 | 内容 |
|------|------|
| ペルソナ | 千葉勇志（チームオーナー）、チームリード |
| 利用頻度 | 日次〜週次でダッシュボードを確認 |
| 主な関心 | チーム全体の活用状況、トレンド変化、パワーユーザーの特定 |
| 技術レベル | 中〜高（ダッシュボードの閲覧が主、設定変更は稀） |
| 利用環境 | PC（Chrome）が主、モバイル対応は優先度低 |

### セカンダリユーザー: チームメンバー

| 属性 | 内容 |
|------|------|
| 利用頻度 | 随時（自分の利用状況確認） |
| 主な関心 | 自分の利用量、ランキング内での位置 |

---

## 5. 機能要件

### 5.1 ダッシュボード Overview

#### FR-001: KPIカード表示

- 6種類のKPIカードを画面上部に横並びで表示する
- 各カードには以下を含む:
  - KPI名（ラベル）
  - 現在値（数値）
  - 前期比変化率（%、上昇は緑↑ / 下降は赤↓）
  - スパークライン（直近トレンドのミニ折れ線グラフ）
- KPIカード一覧:

| # | KPI名 | 説明 | 表示例 |
|---|-------|------|--------|
| 1 | Skill実行数 | 期間内のSkill呼び出し総数 | 56 (+12.0%) |
| 2 | Subagent数 | 期間内のSubagent起動総数 | 508 (-8.5%) |
| 3 | MCP呼び出し | 期間内のMCPツール呼び出し総数 | 720 (+24.4%) |
| 4 | メッセージ | 期間内のメッセージ送受信総数 | 3,085 (-3.4%) |
| 5 | アクティブ | アクティブユーザー数/全ユーザー数、普及率% | 32/34 (94%) |
| 6 | セッション | 期間内のセッション総数 | 584 (-24.2%) |

- アクティブカードのみ、スパークラインの代わりにプログレスバーを表示する

#### FR-002: AI Insights

- Gemini APIを用いた利用パターンの自動分析結果を表示する
- 最大5枚のInsightカードを横スクロール可能な形式で表示
- 各カードには以下を含む:
  - カテゴリラベル（TREND UP / TREND DOWN / POWER USER / USECASE INSIGHT）
  - カテゴリに応じたアイコン・カラー
  - 分析内容テキスト（1〜2文）
- Insightの例:
  - `TREND UP`: MCP呼び出しが大幅増加（+24.35%）
  - `POWER USER`: 特定ユーザーがヘビーユーザー
  - `USECASE INSIGHT`: 調査・バグ修正が利用の中心
  - `TREND DOWN`: Subagent利用数が減少傾向（-8.47%）
  - `TREND UP`: Skill実行数が前期比10%増加

#### FR-003: ユーザー別利用状況テーブル

- ユーザー別の利用状況を一覧テーブルで表示する
- テーブルカラム:
  - 順位（1〜3位は金銀銅メダルアイコン）
  - ユーザー名
  - 最終利用時間（相対表示: 例「2時間前」）
  - Skill数
  - Subagent数
  - MCP数
  - Command数
  - Message数
  - 合計
- 各カラムでソート可能（クリックで昇順/降順切替）
- デフォルトは合計の降順

### 5.2 ツール分析

#### FR-004: ツールカテゴリ別サブタブ

- 以下の4つのサブタブを提供する:
  - スキル（Skills）
  - サブエージェント（Subagents）
  - MCP
  - スラッシュコマンド（Slash Commands）
- 各サブタブは同一レイアウトで、対象データのみ異なる

#### FR-005: 利用トレンドグラフ

- 時系列の折れ線グラフを表示する
- X軸: 時間（期間フィルターに応じて粒度変更: 1D=1時間刻み / 7D=日刻み / 30D=日刻み）
- Y軸: 利用回数
- 表示モード切替タブ:
  - 総数: 全体の利用数推移
  - ユーザー別: ユーザーごとに色分けした折れ線
  - ユースケース別: ユースケース分類ごとの折れ線

#### FR-006: 利用分布チャート

- ドーナツチャートで各ツール/スキルの利用割合を表示する
- 中央に合計数を表示
- ホバーで各セグメントの詳細（名称・件数・割合%）をツールチップで表示

#### FR-007: ツール別利用数ランキング

- 横棒グラフでツール/スキル別の利用数を降順で表示する
- 最大10件を表示し、それ以下は「その他」に集約
- テーブル形式のランキングも併設（順位・ツール名・利用回数・割合%）

### 5.3 期間フィルター

#### FR-008: 期間フィルター

- 画面上部に期間フィルターを常時表示する
- プリセット: 1D（24時間）/ 7D（7日間）/ 30D（30日間）/ All（全期間）
- カスタム期間: 日付ピッカーで任意の開始日〜終了日を指定可能
- フィルター変更時、全KPI・グラフ・テーブルを即座に再取得・再描画する

### 5.4 グローバルナビゲーション

#### FR-009: ナビゲーション

- 左サイドバーまたは上部タブバーで以下のページを切替可能にする:
  - ダッシュボード（Overview）
  - ツール分析
  - トークン使用量（将来実装 / Comming Soon表示）
  - ユーザー一覧（将来実装 / Comming Soon表示）

### 5.5 将来実装（Phase 2以降）

#### FR-010: トークン使用量ページ

- ユーザー別・日別のトークン消費量を可視化する
- Phase 1ではプレースホルダー表示（Coming Soon）

#### FR-011: ユーザー一覧ページ

- 全ユーザーの詳細プロフィール・個別利用サマリーを表示する
- Phase 1ではプレースホルダー表示（Coming Soon）

---

## 6. 非機能要件

#### NFR-001: パフォーマンス

- ダッシュボード初回表示: 3秒以内（LCP）
- フィルター変更時のデータ更新: 1秒以内
- JSONLファイルの集計処理: 10万行のログに対して5秒以内

#### NFR-002: スケーラビリティ

- ユーザー数: 最大100名を想定
- イベントログ: 1日あたり最大10万件を処理可能であること
- ログファイルサイズ: ローテーション機構を備え、単一ファイルが100MBを超えないこと

#### NFR-003: 可用性

- ダッシュボードの可用性: 99%以上（計画メンテナンス除く）
- データ収集（hooks）はClaude Code本体の動作に影響を与えないこと（非同期処理）

#### NFR-004: セキュリティ

- ダッシュボードへのアクセスは認証を必須とする（Phase 1ではBasic認証または環境変数によるトークン認証）
- イベントログにはAPIキー・シークレット等の機密情報を含めないこと
- 通信はHTTPSを使用すること（デプロイ環境依存）

#### NFR-005: ブラウザ対応

- Chrome最新版を主要対象とする
- Safari、Firefox最新版でも基本動作を保証する
- レスポンシブ対応: デスクトップ優先（モバイル対応はPhase 2）

#### NFR-006: データ保持

- イベントログは最低90日間保持する
- 90日経過後のログはアーカイブまたは削除（設定可能）

#### NFR-007: 国際化

- Phase 1はUI日本語のみ
- 英語対応はPhase 2で検討

---

## 7. 技術アーキテクチャ

### 全体構成

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────────┐
│  Claude Code    │     │   Event Log      │     │   Next.js App       │
│  (各ユーザー端末) │────▶│   (JSONL Files)   │────▶│   (API + Dashboard) │
│                 │hooks│                  │read │                     │
└─────────────────┘     └──────────────────┘     └──────────┬──────────┘
                                                            │
                                                            ▼
                                                   ┌────────────────┐
                                                   │  Gemini API    │
                                                   │  (AI Insights) │
                                                   └────────────────┘
```

### データフロー

1. **データ収集**: Claude Codeのhooksシステムがイベント（Skill実行、Subagent起動、MCP呼び出し、メッセージ送信、セッション開始/終了等）を検知
2. **ログ出力**: hooksに登録されたシェルスクリプトがイベントデータをJSONL形式でローカルファイルに追記
3. **データ集約**: 各ユーザーのローカルJSONLファイルを共有ストレージ（NFS/クラウドストレージ）または定期同期で集約
4. **集計API**: Next.js API RoutesがJSONLファイルを読み込み、期間・ユーザー・カテゴリ別に集計してJSONで返却
5. **ダッシュボード表示**: Next.jsフロントエンドが集計APIからデータを取得し、チャート・テーブル・KPIカードを描画
6. **AI Insights**: 定期的に集計データをGemini APIに送信し、利用パターンの分析結果を取得・キャッシュ

### 技術スタック

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| データ収集 | Claude Code hooks + シェルスクリプト | Claude Code標準のプラグインシステム、追加インストール不要 |
| イベントログ | JSONL（JSON Lines） | 追記が高速、行単位で読み取り可能、パース容易 |
| バックエンド | Next.js API Routes (App Router) | フロント・バックエンド統合、デプロイ容易 |
| フロントエンド | Next.js 15 + React 19 + Tailwind CSS v4 + Recharts | モダンUI、チャート描画ライブラリが充実 |
| AI分析 | Gemini API (gemini-2.0-flash) | コスト効率の良いLLM、日本語対応 |
| デプロイ | Vercel or Cloud Run | Next.jsとの親和性、自動スケーリング |

### hooks連携（確定設計）

> **Updated 2026-02-07**: researcher調査結果に基づき確定。詳細は `docs/hooks-research.md` および `docs/data-collection-design.md` を参照。

Claude Codeのhooksは `~/.claude/settings.json` の `hooks` セクションでイベントリスナーを登録する。hookタイプは `command`（シェルスクリプト）を使用。

**収集対象イベント（全10種）**:

| hookイベント | 収集データ | 同期/非同期 |
|---|---|---|
| SessionStart | session_id, source, model | 同期（5秒TO） |
| SessionEnd | session_id, reason | 同期（5秒TO） |
| UserPromptSubmit | prompt_len, is_skill, skill_name | 同期（5秒TO） |
| PostToolUse | tool, category, detail | **非同期** |
| PostToolUseFailure | tool, error_head | **非同期** |
| SubagentStart | agent_id, agent_type | **非同期** |
| SubagentStop | agent_id, agent_type | **非同期** |
| TaskCompleted | task_id, task_subject, teammate, team | **非同期** |
| TeammateIdle | teammate, team | **非同期** |
| PreCompact | trigger | **非同期** |

**収集対象外**: Notification（既存hookと競合回避）、PreToolUse（PostToolUseで十分）

**データフロー**:
1. Claude Codeがhookイベントを発火
2. `cc-logger.sh` がstdinからJSON入力を受け取り
3. 共通フィールド（ts, sid, uid, mid, pmode, project）＋イベント固有フィールドを抽出
4. `~/.claude-code-dashboard/logs/YYYY-MM-DD.jsonl` にappend

**ユーザー識別**: git emailのSHA-256ハッシュ先頭8文字（プライバシー配慮）
**ログ保持**: 90日、1日あたり約300KB推定

---

## 8. データモデル

### 8.1 イベントログスキーマ（JSONLの1行）

```json
{
  "event_id": "uuid-v4",
  "timestamp": "2026-02-07T10:30:00.000Z",
  "user": "chibayuushi",
  "session_id": "session-uuid",
  "event_type": "tool_use",
  "category": "skill",
  "tool_name": "commit",
  "hook_event": "PostToolUse",
  "duration_ms": 1200,
  "status": "success",
  "metadata": {
    "input_tokens": 500,
    "output_tokens": 200,
    "model": "claude-opus-4-6"
  }
}
```

#### フィールド定義

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| event_id | string (UUID v4) | Yes | イベントの一意識別子 |
| timestamp | string (ISO 8601) | Yes | イベント発生時刻 |
| user | string | Yes | ユーザー識別子（OS username等） |
| session_id | string | Yes | Claude Codeセッションの識別子 |
| event_type | enum | Yes | `tool_use` / `message` / `session_start` / `session_end` / `notification` |
| category | enum | Yes (event_type=tool_useの場合) | `skill` / `subagent` / `mcp` / `slash_command` |
| tool_name | string | Conditional | 使用ツール名（event_type=tool_useの場合） |
| hook_event | string | Yes | トリガーとなったhookイベント名 |
| duration_ms | number | No | 実行時間（ミリ秒） |
| status | enum | No | `success` / `error` |
| metadata | object | No | 拡張メタデータ（トークン数、モデル名等） |

#### event_type 定義

| event_type | 説明 | 取得タイミング |
|-----------|------|---------------|
| `tool_use` | ツール（Skill/MCP/Subagent/Command）の実行 | PostToolUse hook |
| `message` | ユーザー⇔AIのメッセージ交換 | Notification hook等 |
| `session_start` | Claude Codeセッション開始 | セッション検知時 |
| `session_end` | Claude Codeセッション終了 | Stop hook |
| `notification` | 通知イベント | Notification hook |

#### category 定義

| category | 対象 | 判定ロジック |
|----------|------|-------------|
| `skill` | Skill実行（/commit, /review-pr等） | tool_name prefix or Skill tool呼び出し |
| `subagent` | Subagent（Task tool）起動 | SubagentStop hook or Task tool検出 |
| `mcp` | MCPツール呼び出し | tool_nameが `mcp__` prefix |
| `slash_command` | スラッシュコマンド | Skill経由でないコマンド実行 |

### 8.2 集計モデル（API応答用）

#### KPIサマリー

```json
{
  "period": {
    "start": "2026-02-01T00:00:00Z",
    "end": "2026-02-07T23:59:59Z"
  },
  "kpis": {
    "skills": { "current": 56, "previous": 50, "change_rate": 12.0, "sparkline": [5, 8, 6, 10, 7, 12, 8] },
    "subagents": { "current": 508, "previous": 555, "change_rate": -8.5, "sparkline": [80, 75, 70, 68, 72, 65, 78] },
    "mcp_calls": { "current": 720, "previous": 579, "change_rate": 24.4, "sparkline": [90, 95, 100, 110, 105, 115, 105] },
    "messages": { "current": 3085, "previous": 3194, "change_rate": -3.4, "sparkline": [450, 420, 440, 460, 430, 445, 440] },
    "active_users": { "active": 32, "total": 34, "rate": 94.1 },
    "sessions": { "current": 584, "previous": 770, "change_rate": -24.2, "sparkline": [100, 90, 85, 80, 78, 75, 76] }
  }
}
```

#### ユーザー別利用状況

```json
{
  "users": [
    {
      "rank": 1,
      "user": "chibayuushi",
      "last_active": "2026-02-07T10:30:00Z",
      "skills": 12,
      "subagents": 85,
      "mcp_calls": 120,
      "commands": 8,
      "messages": 450,
      "total": 675
    }
  ]
}
```

#### ツール別集計

```json
{
  "category": "skill",
  "trend": {
    "labels": ["00:00", "01:00", "02:00"],
    "datasets": {
      "total": [5, 3, 8],
      "by_user": { "chibayuushi": [3, 2, 5], "user2": [2, 1, 3] },
      "by_usecase": { "commit": [2, 1, 4], "review-pr": [3, 2, 4] }
    }
  },
  "distribution": [
    { "name": "commit", "count": 25, "percentage": 44.6 },
    { "name": "review-pr", "count": 18, "percentage": 32.1 }
  ],
  "ranking": [
    { "rank": 1, "name": "commit", "count": 25, "percentage": 44.6 },
    { "rank": 2, "name": "review-pr", "count": 18, "percentage": 32.1 }
  ]
}
```

#### AI Insights

```json
{
  "insights": [
    {
      "type": "TREND_UP",
      "title": "MCP呼び出しが大幅増加",
      "description": "前期比+24.35%。特にGitHub MCP連携の利用が急増しています。",
      "metric": "mcp_calls",
      "change_rate": 24.35
    }
  ],
  "generated_at": "2026-02-07T10:00:00Z",
  "model": "gemini-2.0-flash"
}
```

---

## 9. 画面設計

### 9.1 全体レイアウト

```
┌──────────────────────────────────────────────────────────────┐
│  [Logo] Claude Code Dashboard     [1D] [7D] [30D] [All] [📅] │
├──────────┬───────────────────────────────────────────────────┤
│          │                                                   │
│ ダッシュ  │  メインコンテンツエリア                              │
│ ボード   │                                                   │
│          │                                                   │
│ ツール    │                                                   │
│ 分析     │                                                   │
│          │                                                   │
│ トークン  │                                                   │
│ (Soon)   │                                                   │
│          │                                                   │
│ ユーザー  │                                                   │
│ (Soon)   │                                                   │
│          │                                                   │
└──────────┴───────────────────────────────────────────────────┘
```

### 9.2 ダッシュボード Overview

#### KPIカードセクション

```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ Skill実行数  │ Subagent数   │ MCP呼び出し   │ メッセージ    │ アクティブ    │ セッション    │
│             │             │             │             │             │             │
│    56       │    508      │    720      │   3,085     │   32/34     │    584      │
│  ↑ 12.0%   │  ↓ -8.5%   │  ↑ 24.4%   │  ↓ -3.4%   │   94%普及率  │  ↓ -24.2%  │
│  ～～～～～  │  ～～～～～  │  ～～～～～  │  ～～～～～  │  ████████░░  │  ～～～～～  │
│ (sparkline) │ (sparkline) │ (sparkline) │ (sparkline) │ (progress)  │ (sparkline) │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

- カードはグリッドレイアウト（デスクトップ: 6列、タブレット: 3列x2行）
- 変化率のカラー: 正の値 = 緑 (#22C55E) / 負の値 = 赤 (#EF4444)
- スパークライン: 高さ32px、期間内の日次データポイント
- アクティブカード: プログレスバー（緑 #22C55E、背景 #E5E7EB）

#### AI Insightsセクション

```
┌─────────────────────────────────────────────────────────────────────┐
│  AI Insights  Powered by Gemini                                     │
│                                                                     │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──── │
│  │ TREND UP ↑ │ │POWER USER👤│ │USECASE 💡  │ │TREND DOWN ↓│ │TREN │
│  │            │ │            │ │            │ │            │ │     │
│  │ MCP呼び出し │ │ ○○さんが   │ │ 調査・バグ  │ │ Subagent   │ │Skil │
│  │ が大幅増加  │ │ ヘビー     │ │ 修正が中心  │ │ 利用数が   │ │実行数│
│  │ +24.35%    │ │ ユーザー   │ │            │ │ 減少傾向   │ │が前期│
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └──── │
│                                                           [< >]     │
└─────────────────────────────────────────────────────────────────────┘
```

- 横スクロール可能（5枚以上の場合、矢印ボタンまたはスワイプ）
- カテゴリ別のカラー:
  - TREND UP: 緑系 (#DCFCE7 背景, #16A34A テキスト)
  - TREND DOWN: 赤系 (#FEE2E2 背景, #DC2626 テキスト)
  - POWER USER: 青系 (#DBEAFE 背景, #2563EB テキスト)
  - USECASE INSIGHT: 紫系 (#F3E8FF 背景, #9333EA テキスト)

#### ユーザー別利用状況テーブル

```
┌────┬──────────────┬──────────┬───────┬──────────┬──────┬─────────┬─────────┬───────┐
│ #  │ ユーザー      │ 最終利用  │ Skill │ Subagent │ MCP  │ Command │ Message │ 合計  │
├────┼──────────────┼──────────┼───────┼──────────┼──────┼─────────┼─────────┼───────┤
│ 🥇 │ chibayuushi  │ 2時間前   │   12  │    85    │ 120  │    8    │   450   │  675  │
│ 🥈 │ user-2       │ 5時間前   │    8  │    72    │  95  │    5    │   380   │  560  │
│ 🥉 │ user-3       │ 1日前     │    6  │    60    │  80  │    3    │   320   │  469  │
│  4 │ user-4       │ 3時間前   │    5  │    55    │  75  │    4    │   300   │  439  │
│ ...│ ...          │ ...      │  ...  │   ...    │ ...  │   ...   │   ...   │  ...  │
└────┴──────────────┴──────────┴───────┴──────────┴──────┴─────────┴─────────┴───────┘
```

- ヘッダークリックでソート切替（昇順/降順）
- ソート中のカラムにインジケーター矢印を表示
- 行ホバーで背景色変更（#F9FAFB）

### 9.3 ツール分析ページ

#### サブタブ

```
[スキル] [サブエージェント] [MCP] [スラッシュコマンド]
```

- 選択中のタブにアクティブインジケーター（下線、太字）

#### 利用トレンドセクション

```
┌─────────────────────────────────────────────────────────────┐
│  利用トレンド              [総数] [ユーザー別] [ユースケース別]  │
│                                                             │
│  件│                                                        │
│  数│        ╱╲      ╱╲                                      │
│    │   ╱╲╱╱  ╲╱╲╱╲╱  ╲╱╲                                  │
│    │╱╱╱                   ╲╲                                │
│    └────────────────────────────────────────────── 時間      │
│     00  02  04  06  08  10  12  14  16  18  20  22          │
└─────────────────────────────────────────────────────────────┘
```

- Rechartsの `LineChart` コンポーネントを使用
- ユーザー別: 最大5ユーザーを色分け表示、レジェンド付き
- ユースケース別: ツール名ごとに色分け表示

#### 利用分布 + ランキングセクション（横並び）

```
┌──────────────────────────┐  ┌──────────────────────────────┐
│  利用分布                 │  │  利用数ランキング             │
│                          │  │                              │
│       ┌─────┐            │  │  commit        ████████ 25   │
│     ╱  44.6% ╲           │  │  review-pr     ██████  18    │
│    │  commit   │  56     │  │  pdf           ████    12    │
│    │           │         │  │  search        ███      9    │
│     ╲  32.1% ╱           │  │  deploy        ██       6    │
│       └─────┘            │  │                              │
│    review-pr             │  │                              │
└──────────────────────────┘  └──────────────────────────────┘
```

- ドーナツチャート: Rechartsの `PieChart` （innerRadius指定）
- 横棒グラフ: Rechartsの `BarChart` （layout="vertical"）
- カラーパレット: Tailwind CSS の標準カラー（blue-500, emerald-500, violet-500, amber-500, rose-500...）

### 9.4 期間フィルター

```
[1D] [7D] [30D] [All] [📅 2026/01/01 〜 2026/02/07]
```

- ボタングループ: 選択中はフィル背景 (#3B82F6 白文字)、未選択は白背景
- カスタム日付: クリックでカレンダーポップオーバー表示
- フィルター状態はURLクエリパラメータに同期（ブックマーク・共有可能）

### 9.5 Coming Soonページ

```
┌─────────────────────────────────────┐
│                                     │
│          🚧 Coming Soon             │
│                                     │
│   この機能は現在開発中です。           │
│   今後のアップデートをお楽しみに。      │
│                                     │
└─────────────────────────────────────┘
```

---

## 10. API設計

### ベースURL

```
/api/v1
```

### エンドポイント一覧

#### GET /api/v1/kpis

KPIサマリーを取得する。

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| start | string (ISO 8601) | No | 7日前 | 期間開始日時 |
| end | string (ISO 8601) | No | 現在 | 期間終了日時 |

**レスポンス**: セクション8.2「KPIサマリー」参照

---

#### GET /api/v1/users

ユーザー別利用状況を取得する。

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| start | string (ISO 8601) | No | 7日前 | 期間開始日時 |
| end | string (ISO 8601) | No | 現在 | 期間終了日時 |
| sort_by | string | No | total | ソートカラム名 |
| sort_order | string | No | desc | asc / desc |

**レスポンス**: セクション8.2「ユーザー別利用状況」参照

---

#### GET /api/v1/tools/:category

ツールカテゴリ別の集計データを取得する。

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| category (path) | enum | Yes | - | `skills` / `subagents` / `mcp` / `commands` |
| start | string (ISO 8601) | No | 7日前 | 期間開始日時 |
| end | string (ISO 8601) | No | 現在 | 期間終了日時 |
| granularity | string | No | auto | `hour` / `day` / `week` |

**レスポンス**: セクション8.2「ツール別集計」参照

---

#### GET /api/v1/insights

AI Insightsを取得する。

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| start | string (ISO 8601) | No | 7日前 | 期間開始日時 |
| end | string (ISO 8601) | No | 現在 | 期間終了日時 |
| limit | number | No | 5 | 取得するInsight数 |

**レスポンス**: セクション8.2「AI Insights」参照

- Insightsはサーバーサイドでキャッシュされ、最大1時間の有効期限を持つ
- キャッシュが存在しない場合、リクエスト時にGemini APIを呼び出して生成する

---

#### GET /api/v1/health

ヘルスチェックエンドポイント。

**レスポンス**:
```json
{
  "status": "ok",
  "timestamp": "2026-02-07T10:00:00Z",
  "log_file_size_mb": 45.2,
  "total_events": 125000
}
```

---

### エラーレスポンス

```json
{
  "error": {
    "code": "INVALID_PARAMETER",
    "message": "start must be a valid ISO 8601 date string"
  }
}
```

| HTTPステータス | code | 説明 |
|---------------|------|------|
| 400 | INVALID_PARAMETER | パラメータ不正 |
| 401 | UNAUTHORIZED | 認証エラー |
| 404 | NOT_FOUND | リソース不明 |
| 500 | INTERNAL_ERROR | サーバーエラー |

---

## 11. 実装スケジュール

### Phase 1: MVP（推定工数: 2-3日）

| タスク | 内容 | 優先度 |
|--------|------|--------|
| P1-1 | hooks用データ収集スクリプト作成 | High |
| P1-2 | JSONLパーサー・集計ロジック実装 | High |
| P1-3 | Next.jsプロジェクトセットアップ | High |
| P1-4 | KPI集計API実装（/api/v1/kpis, /api/v1/users） | High |
| P1-5 | ダッシュボード Overview UI実装（KPIカード + テーブル） | High |
| P1-6 | 期間フィルター実装 | High |
| P1-7 | ツール分析API + UI実装 | Medium |
| P1-8 | AI Insights（Gemini API連携） | Medium |
| P1-9 | 認証（Basic認証） | Medium |

**Phase 1完了基準**: ダッシュボードOverview + ツール分析が動作し、実データで表示可能な状態

### Phase 2: 拡充（Phase 1完了後）

| タスク | 内容 |
|--------|------|
| P2-1 | トークン使用量ページ実装 |
| P2-2 | ユーザー一覧ページ実装 |
| P2-3 | レスポンシブ対応（モバイル） |
| P2-4 | ログローテーション・アーカイブ機構 |
| P2-5 | データ同期機構（複数端末 → 集約サーバー） |

### Phase 3: 高度化（Phase 2完了後）

| タスク | 内容 |
|--------|------|
| P3-1 | リアルタイム更新（WebSocket / SSE） |
| P3-2 | アラート・通知機能（利用率低下等） |
| P3-3 | 英語対応 |
| P3-4 | カスタムダッシュボード（ウィジェット配置変更） |

---

## 12. 環境変数一覧

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `GEMINI_API_KEY` | Yes | - | Gemini API認証キー |
| `LOG_DIR` | No | `./logs` | JSONLイベントログの保存ディレクトリ |
| `LOG_RETENTION_DAYS` | No | `90` | ログ保持日数 |
| `DASHBOARD_AUTH_TOKEN` | No | - | ダッシュボード認証トークン（設定時にBasic認証有効化） |
| `INSIGHTS_CACHE_TTL_SEC` | No | `3600` | AI Insightsキャッシュ有効期間（秒） |
| `INSIGHTS_MAX_COUNT` | No | `5` | AI Insightsの最大生成数 |
| `NEXT_PUBLIC_APP_TITLE` | No | `Claude Code Dashboard` | アプリタイトル |
| `NODE_ENV` | No | `development` | 実行環境 |

---

## 13. テスト・検証計画

### 13.1 ユニットテスト

| 対象 | テスト内容 |
|------|-----------|
| JSONLパーサー | 正常行・不正行・空行の処理、大容量ファイル（10万行） |
| 集計ロジック | 期間フィルター、ユーザー別集計、カテゴリ別集計、前期比計算 |
| APIルート | パラメータバリデーション、レスポンス形式、エラーハンドリング |

### 13.2 統合テスト

| 対象 | テスト内容 |
|------|-----------|
| hooksスクリプト | Claude Codeイベント発火時にJSONLが正しく追記されること |
| API → UI | APIレスポンスがKPIカード・グラフ・テーブルに正しく反映されること |
| Gemini連携 | 集計データ送信 → Insight生成 → キャッシュ → 表示の一連フロー |

### 13.3 E2Eテスト

| シナリオ | 検証内容 |
|---------|-----------|
| ダッシュボード閲覧 | 初回表示でKPIカード6枚・AI Insights・テーブルが表示される |
| 期間切替 | 1D→7D→30Dの切替で全データが正しく再描画される |
| ツール分析 | サブタブ切替でグラフ・チャート・ランキングが正しく更新される |
| ソート | テーブルのカラムヘッダークリックでソートが正しく動作する |

### 13.4 パフォーマンステスト

| 対象 | 基準 |
|------|------|
| ダッシュボード初回表示（LCP） | 3秒以内 |
| フィルター変更後の再描画 | 1秒以内 |
| 10万行JSONLの集計処理 | 5秒以内 |

---

## 14. リスクと対策

| # | リスク | 影響度 | 発生確率 | 対策 |
|---|--------|--------|---------|------|
| R-001 | hooks仕様がClaude Code側で変更される | 高 | 中 | データ収集スクリプトを疎結合に設計し、hooks変更時にスクリプトのみ修正で対応可能にする |
| R-002 | JSONLファイルが肥大化し集計処理が遅延する | 中 | 高 | ログローテーション（日次分割）、集計結果のキャッシュ機構を導入する |
| R-003 | Gemini APIの応答遅延・レート制限 | 中 | 中 | Insightsにキャッシュ（TTL: 1時間）を設け、バックグラウンドで定期更新する。API障害時はキャッシュ済みデータを表示 |
| R-004 | 複数端末のログ集約が困難 | 高 | 中 | Phase 1ではローカル単一端末のみ対応。Phase 2でNFS/クラウドストレージによる集約を実装 |
| R-005 | イベントログに機密情報が混入する | 高 | 低 | hooksスクリプトでフィルタリングし、APIキー・シークレット等をマスク/除外する |
| R-006 | hooksスクリプトがClaude Codeのパフォーマンスに影響する | 中 | 低 | 全てのhooks処理を非同期（バックグラウンド）で実行し、Claude Code本体のレスポンスをブロックしない |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2026-02-07 | 1.0 | 初版作成 | 神崎凛 |
